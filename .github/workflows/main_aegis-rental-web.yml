name: Deploy Aegis-AO Rental to Azure Web App

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

concurrency:
  group: deploy-azure-webapp
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: 'Checkout code'
      uses: actions/checkout@v4
      
    - name: 'Setup Node.js'
      uses: actions/setup-node@v3
      with:
        node-version: '20.x'
        
    - name: 'Install root dependencies'
      run: |
        npm install
        echo "âœ… Root dependencies installed"
        
    - name: 'Install and build client'
      run: |
        cd client
        npm install
        echo "âœ… Client dependencies installed"
        echo "Checking if react-scripts is installed:"
        ls -la node_modules/.bin/ | grep react-scripts
        npm run build
        echo "âœ… React client built successfully"
        
    - name: 'Copy client build to server public'
      run: |
        # Copy React build output
        cp -r client/build/* server/public/
        echo "âœ… Client build copied to server/public"
        
        # Ensure models directory exists in server/public
        mkdir -p server/public/models
        
        # Copy model images from source (client/public/models) to server/public/models
        # This ensures they're available even if React build doesn't copy them
        if [ -d client/public/models ]; then
          echo "ðŸ“ Found client/public/models directory"
          cp -r client/public/models/* server/public/models/
          echo "âœ… Model images copied from client/public/models to server/public/models"
        else
          echo "âš ï¸ client/public/models directory not found"
        fi
        
        # Also check if React build included models folder
        if [ -d client/build/models ]; then
          echo "ðŸ“ Found models in React build, copying..."
          cp -r client/build/models/* server/public/models/ 2>/dev/null || true
        fi
        
        # Verify models folder was created and has files
        if [ -d server/public/models ]; then
          MODEL_COUNT=$(ls -1 server/public/models/*.png 2>/dev/null | wc -l)
          echo "âœ… Models folder exists with $MODEL_COUNT PNG images"
          if [ "$MODEL_COUNT" -eq 0 ]; then
            echo "âŒ WARNING: No PNG images found in server/public/models"
            echo "ðŸ“‹ Listing server/public/models:"
            ls -la server/public/models/ || echo "Directory is empty or doesn't exist"
          else
            echo "ðŸ“‹ Sample files in server/public/models:"
            ls -1 server/public/models/*.png | head -5
          fi
        else
          echo "âŒ ERROR: Models folder not created!"
        fi
        
    - name: 'Install server dependencies'
      run: |
        cd server
        npm install
        echo "âœ… Server dependencies installed"
        
    - name: 'Create deployment package'
      run: |
        # Create directory structure - flat structure with index.js at root
        mkdir -p deploy
        
        # Copy server files directly to deploy root (index.js will be at root)
        cp -r server/* deploy/
        
        # Copy package.json from server (has correct dependencies)
        cp server/package.json deploy/package.json
        cp server/package-lock.json deploy/package-lock.json 2>/dev/null || true
        
        # Remove web.config (not needed for Linux, causes .NET detection)
        rm -f deploy/web.config
        
        # Create a .deployment file to tell Azure not to build
        echo "[config]" > deploy/.deployment
        echo "SCM_DO_BUILD_DURING_DEPLOYMENT = false" >> deploy/.deployment
        
        # Verify models folder is included in deployment
        echo "ðŸ“‹ Checking deployment package contents:"
        ls -la deploy/
        echo ""
        echo "Checking index.js exists:"
        test -f deploy/index.js && echo "âœ… index.js found at root" || echo "âŒ index.js NOT found"
        echo ""
        echo "Checking public/models folder:"
        if [ -d deploy/public/models ]; then
          MODEL_COUNT=$(ls -1 deploy/public/models/*.png 2>/dev/null | wc -l)
          echo "âœ… public/models folder exists with $MODEL_COUNT PNG images"
          if [ "$MODEL_COUNT" -gt 0 ]; then
            echo "ðŸ“‹ Sample model images:"
            ls -1 deploy/public/models/*.png | head -3
          fi
        else
          echo "âŒ WARNING: public/models folder NOT found in deployment package!"
          echo "ðŸ“‹ Contents of deploy/public:"
          ls -la deploy/public/ 2>/dev/null || echo "public folder doesn't exist"
        fi
        
        echo "âœ… Deployment package created"
        
    - name: 'Deploy to Azure Web App'
      uses: azure/webapps-deploy@v2
      with:
        app-name: 'aegis-rental-web'
        package: './deploy'
        publish-profile: ${{ secrets.AZUREAPPSERVICE_PUBLISHPROFILE_E6027D9BD29E4990850207EC50731463 }}
