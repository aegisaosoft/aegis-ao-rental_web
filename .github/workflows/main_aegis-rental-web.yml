name: Deploy Aegis-AO Rental to Azure Web App

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

concurrency:
  group: deploy-azure-webapp
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: 'Checkout code'
      uses: actions/checkout@v4
      
    - name: 'Setup Node.js'
      uses: actions/setup-node@v3
      with:
        node-version: '20.x'
        
    - name: 'Install root dependencies'
      run: |
        npm install
        echo "✅ Root dependencies installed"
        
    - name: 'Install and build client'
      run: |
        cd client
        npm install
        echo "✅ Client dependencies installed"
        echo "Checking if react-scripts is installed:"
        ls -la node_modules/.bin/ | grep react-scripts
        npm run build
        echo "✅ React client built successfully"
        
    - name: 'Copy client build to server public'
      run: |
        cp -r client/build/* server/public/
        echo "✅ Client build copied to server/public"
        
    - name: 'Install server dependencies'
      run: |
        cd server
        npm install
        echo "✅ Server dependencies installed"
        
    - name: 'Create deployment package'
      run: |
        # Create directory structure - flat structure with index.js at root
        mkdir -p deploy
        
        # Copy server files directly to deploy root (index.js will be at root)
        cp -r server/* deploy/
        
        # Copy package.json from server (has correct dependencies)
        cp server/package.json deploy/package.json
        cp server/package-lock.json deploy/package-lock.json 2>/dev/null || true
        
        # Remove web.config (not needed for Linux, causes .NET detection)
        rm -f deploy/web.config
        
        # Create a .deployment file to tell Azure not to build
        echo "[config]" > deploy/.deployment
        echo "SCM_DO_BUILD_DURING_DEPLOYMENT = false" >> deploy/.deployment
        
        echo "✅ Deployment package created"
        ls -la deploy/
        echo "Checking index.js exists:"
        test -f deploy/index.js && echo "✅ index.js found at root" || echo "❌ index.js NOT found"
        
    - name: 'Deploy to Azure Web App'
      uses: azure/webapps-deploy@v2
      with:
        app-name: 'aegis-rental-web'
        package: './deploy'
        publish-profile: ${{ secrets.AZUREAPPSERVICE_PUBLISHPROFILE_E6027D9BD29E4990850207EC50731463 }}
