name: Deploy Aegis-AO Rental to Azure Web App

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

concurrency:
  group: deploy-azure-webapp
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: 'Checkout code'
      uses: actions/checkout@v4
      
    - name: 'Setup Node.js'
      uses: actions/setup-node@v3
      with:
        node-version: '20.x'
        
    - name: 'Install root dependencies'
      run: |
        npm install
        echo "✅ Root dependencies installed"
        
    - name: 'Install and build client'
      run: |
        cd client
        npm install
        echo "✅ Client dependencies installed"
        echo "Checking if react-scripts is installed:"
        ls -la node_modules/.bin/ | grep react-scripts
        npm run build
        echo "✅ React client built successfully"
        
    - name: 'Copy client build to server public'
      run: |
        cp -r client/build/* server/public/
        echo "✅ Client build copied to server/public"
        
    - name: 'Install server dependencies'
      run: |
        cd server
        npm install
        echo "✅ Server dependencies installed"
        
    - name: 'Create deployment package'
      run: |
        # Create directory structure
        mkdir -p deploy/server
        
        # Copy server files (includes client build in server/public)
        cp -r server/* deploy/server/
        cp package.json deploy/
        cp package-lock.json deploy/
        
        # Create a .deployment file to tell Azure not to build
        echo "[config]" > deploy/.deployment
        echo "SCM_DO_BUILD_DURING_DEPLOYMENT = false" >> deploy/.deployment
        
        echo "✅ Deployment package created"
        ls -la deploy/
        echo "Server structure:"
        ls -la deploy/server/
        
    - name: 'Deploy to Azure Web App'
      uses: azure/webapps-deploy@v2
      with:
        app-name: 'aegis-rental-web'
        package: './deploy'
        publish-profile: ${{ secrets.AZUREAPPSERVICE_PUBLISHPROFILE_E6027D9BD29E4990850207EC50731463 }}
